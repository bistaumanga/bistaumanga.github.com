<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name=description content="Personal website and blog of Umanga Bista">


  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <title>
    
    Improving performance of Local outlier factor with KD-Trees | 
    
    Umanga Bista

  </title>

  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
  </script>

  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50991800-1', 'bistaumanga.com.np');
  ga('send', 'pageview');

  </script>

  <link rel=stylesheet type=text/css href=/css/github.css>
  <link rel=stylesheet type=text/css href=/css/styles.css>
  <link rel=stylesheet type=text/css href=/css/highlight.css>

  

  </head>

  <body>

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">  
    <div class="container-fluid">

    <div class="navbar-header">
      <button type="button" class="navbar-toggle hidden-xs" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="navbar-brand visible-xs" href="/" style="padding: .2em .5em;"><img src="http://s.gravatar.com/avatar/05710f1aef9f9b4aed9b61381cd625db?s=40" class="img-circle" /></a>
      <a class="navbar-brand hidden-xs" href="/">UMB</a>

      <div class="navbar-header visible-xs" style="padding:0;">
        <a class="navbar-toggle nav-link" href="/blog" style="color:#8B7500; margin-right:0.1em;padding:0.2em;">
          <i class="fa fa-pencil-square fa-lg fa-fw"></i>Blog
        </a>

        <a class="navbar-toggle nav-link" href="https://github.com/bistaumanga" target="_blank" style="color:#000;margin-right:1.5em;padding:0.2em;">
          <i class="fa fa-github-square fa-lg"></i>
        </a>

        <a class="navbar-toggle nav-link" href="https://np.linkedin.com/in/bistaumanga" target="_blank" style="color:#007bb6;margin-right:0.1em;padding:0.2em;">
          <i class="fa fa-linkedin-square fa-lg"></i>
        </a>

        <a class="navbar-toggle nav-link" href="mailto:mail@bistaumanga.com.np" target="_blank" style="color:#6E329D;margin-right:0.1em;padding:0.2em;">
          <i class="fa fa-envelope fa-lg"></i>
        </a>

        <a class="navbar-toggle nav-link" href="/files/cv.pdf" style="color: #DC143C;;margin-right:0.25em;padding:0.2em;" target="_blank">
          <i class="fa fa-download fa-fw"></i>CV</a>
        </a>

        <!-- <div class="btn-group" style="padding:.8em 0 0 0;">
          <a class="btn btn-default btn-sx" href="https://github.com/bistaumanga" style="color:#000;" target="_blank">
              <i class="fa fa-github-alt fa-lg"></i>
          </a>
          <a class="btn btn-default btn-sx" href="https://np.linkedin.com/in/bistaumanga" style="color:#007bb6;" target="_blank">
              <i class="fa fa-linkedin-square fa-lg"></i>
          </a>
          <a class="btn btn-default btn-sx" href="mailto:mail@bistaumanga.com.np" style="color:#6E329D;" target="_blank">
              <i class="fa fa-envelope fa-lg"></i>
          <a class="btn btn-default btn-sx" href="files/cv.pdf" style="color: #DC143C;align: center;" target="_blank"><i class="fa fa-download fa-lg fa-fw"></i>CV</a>
          </a>
        </div> -->


        
        </a>
      </div>

    </div>

    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/"><i class="fa fa-home fa-lg"></i></a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/tags">tags</a></li>
      </ul>
    </div>
    

  </div>

  </nav>

    <div class="col-sm-3 sidebar hidden-xs" style = "height: 100%;">
        <header class="sidebar-header">
    <img src="http://s.gravatar.com/avatar/05710f1aef9f9b4aed9b61381cd625db?s=160" class="img-circle" />
    <h3><a href=/>Umanga Bista<br>(उमङ्ग बिष्ट)</a></h3>
</header>
<div style = "color:#8B7500;" align = center>  

 Machine learninng, Big data and Stream mining enthusiast

</div>
<br>
<div align=center>
    <div class="btn-group">
        <a class="btn btn-default btn-sm" href="https://github.com/bistaumanga" style="color:#000;" target="_blank">
            <i class="fa fa-github-alt fa-2x"></i>
        </a>
        <a class="btn btn-default btn-sm" href="https://np.linkedin.com/in/bistaumanga" style="color:#007bb6;" target="_blank">
            <i class="fa fa-linkedin-square fa-2x"></i>
        </a>
        <a class="btn btn-default btn-sm" href="mailto:mail@bistaumanga.com.np" style="color:#6E329D;" target="_blank">
            <i class="fa fa-envelope fa-2x"></i>
        </a>
    </div>
    <br><br>
    <a class="btn btn-default btn-sm" href="/files/cv.pdf" style="color: #DC143C;align: center;" target="_blank"><i class="fa fa-download fa-lg"></i>CV</a>
    <br><br>
    <a class="btn btn-link btn-sm" href="https://db.tt/rJjB3Llm" style="align: center;" target="_blank"> <i class="fa fa-dropbox fa-lg"></i> Free Online Storage </a>

</div>
    </div>  

    <div class="col-xs-18 col-sm-9 col-sm-offset-3" style="padding:1em;">    
      <div class=post>
    
    <ul class=post-meta>
    
        
    
    <li><i class="fa fa-calendar fa-lg fa-fw" style="color:#ff2288;"></i>April 21, 2014</li>
    
        <li><i class="fa fa-tag fa-lg fa-fw" style="color:#28c;"></i><a href="/tags/#outlier,-ref">outlier,</a></li>
    
        <li><i class="fa fa-tag fa-lg fa-fw" style="color:#28c;"></i><a href="/tags/#local-outlier,-ref">local-outlier,</a></li>
    
        <li><i class="fa fa-tag fa-lg fa-fw" style="color:#28c;"></i><a href="/tags/#kd-tree-ref">kd-tree</a></li>
    
</ul>

    <h1 class=title-large>Improving performance of Local outlier factor with KD-Trees</h1>
    <div class=content>
        <br>
        <script src="//platform.linkedin.com/in.js" type="text/javascript">
        lang: en_US
        </script>
        <script type="IN/Share" data-counter="right"></script>
        <div class="g-plus" data-action="share" data-height="24"></div>
        <div class="fb-like" rel="canonical" data-href= "" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
        

        <p>Local outlier factor (LOF) is an outlier detection algorithm, that detects
outliers based on comparing local density of data instance with its neighbors.
It does so to decide if data instance belongs to region of similar density. It
can detect an outlier in a dataset, for which number of clusters is unknown, and
clusters are of different density and size. It's inspired from KNN (K-Nearest
Neighbors) algorithm, and is widely used. There is a <a href="http://www.rdatamining.com/examples/outlier-detection">R implemantation
available.</a></p>

<p>The naive approach to do this is to form all pair euclidan distance matrix, and
then run knn query to proceed further. But this approach just sucks, as it is
$\Theta(n^2)$ in terms of both space and time complexity. But, this can be
improvd with <a href="http://en.wikipedia.org/wiki/K-d_tree">KDTrees.</a>, and already its
<a href="http://scikit-learn.org/stable/modules/neighbors.html">implementation</a> exists
in python, thanks to scipy, so lets use this to find outliers.</p>

<h4 id="synthetic-dataset">Synthetic dataset</h4>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">pylab</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># to reproduce the result</span></code></pre></div>

<p>Populating the interactive namespace from numpy and matplotlib</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span> <span class="c"># number of dimensions of dataset = 2</span>
<span class="c"># cluster of normal random variable moderately dense</span>
<span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1500</span><span class="p">],</span> <span class="p">[[</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">]],</span> <span class="mi">2000</span><span class="p">)</span>

<span class="c"># very dense</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">([</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]],</span> <span class="mi">2500</span><span class="p">)</span>

<span class="c"># sparse</span>
<span class="n">data3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">([</span><span class="mi">2500</span><span class="p">,</span> <span class="mi">2500</span><span class="p">],</span> <span class="p">[[</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">]],</span> <span class="mi">500</span><span class="p">)</span>

<span class="c"># mix the three dataset and shuffle</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)),</span> <span class="n">data3</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c"># add some noise : zipf is skewed distribution and can have extreme values(outliers)</span>
<span class="n">zipf_alpha</span> <span class="o">=</span> <span class="mf">2.25</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">zipf</span><span class="p">(</span><span class="n">zipf_alpha</span><span class="p">,</span> <span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">data</span> <span class="o">+=</span> <span class="n">noise</span></code></pre></div>

<h4 id="naive-approach-to-lof">Naive approach to LOF</h4>

<p>Pairwise Euclidean distance calculation with DistanceMetric implementation in
scikit-learn. In this, we just compute all-pair euclidean distance, i.e. $d(i,
j) = |x(i)-x(j)|_2$.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">DistanceMetric</span>
 <span class="c"># distance between points</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">DistanceMetric</span><span class="o">.</span><span class="n">get_metric</span><span class="p">(</span><span class="s">&#39;euclidean&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pairwise</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;++ took </span><span class="si">%g</span><span class="s"> msecs for Distance computation&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">++</span> <span class="n">took</span> <span class="mi">740</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">Distance</span> <span class="n">computation</span></code></pre></div>

<p>Performing KNN query.In this step, the nearest k neighbors are identified
$N_k(i)$, and radius is the distance of k-th rearest neighbor of a datapoint.
<script type="math/tex"> r(i) = \max_{k \in N_k(i)} d(i, k) </script></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">17</span> <span class="c"># number of neighbors to consider</span>
<span class="c"># get the radius for each point in dataset (distance to kth nearest neighbor)</span>
<span class="c"># radius is the distance of kth nearest point for each point in dataset        </span>
<span class="n">idx_knn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="mi">1</span> <span class="p">:</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="c"># by row&#39; get k nearest neighbour   </span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">idx_knn</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c"># radius</span>
<span class="k">print</span> <span class="s">&#39;+++ took </span><span class="si">%g</span><span class="s"> msecs for KNN Querying&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">+++</span> <span class="n">took</span> <span class="mi">4800</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">KNN</span> <span class="n">Querying</span></code></pre></div>

<p>Then LRD(Local Reachability distance) is calculated. For this, first reach
distance $rd(i, j)$ is computed between point concern $x(i)$ and its neighbors $
j:j\in N_k(i)$, which is the maximum of euclidean distance or radius $r(i)$ of
point concerned. Then, LRD is the inverse of mean of reach distance of all
k-neighbors of each point.
<script type="math/tex"> rd(i, j) = \max{\{d(i, j), r(i) }\} for\ j\in N_k(i) </script>
<script type="math/tex">LRD(i) = \frac{|N_k(i)|}{ \sum_{j \in N_k(i) }{rd(i, j)}} </script></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># calculate the local reachability density</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">LRD</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx_knn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">LRD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">idx_knn</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">radius</span><span class="p">[</span><span class="n">idx_knn</span><span class="p">[</span><span class="n">i</span><span class="p">]])))</span>
<span class="k">print</span> <span class="s">&#39;++++ took </span><span class="si">%g</span><span class="s"> msecs for LRD computation&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">++++</span> <span class="n">took</span> <span class="mi">429</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">LRD</span> <span class="n">computation</span></code></pre></div>

<p>finally, the outlier score $LOF$ is calsulated.
<script type="math/tex"> LOF(i) = \frac { \sum_{j \in N_k(i)} {\frac{LRD(j)}{LRD(i)} }} { |N_k(i)|} </script></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># calculating the outlier score</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LRD</span><span class="p">)</span> <span class="c"># inverse of density</span>
<span class="n">outlier_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="n">idx_knn</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<span class="n">outlier_score</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">k</span>
<span class="k">print</span> <span class="s">&#39;+++++ took </span><span class="si">%g</span><span class="s"> msecs for Outlier scoring&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">+++++</span> <span class="n">took</span> <span class="mf">9.99999</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">Outlier</span> <span class="n">scoring</span></code></pre></div>

<p>Now lets se the histogram of Outlier score, to choose the optimal threshold to
decid weather a data-point is outlier is not.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">outlier_score</span><span class="p">)</span><span class="o">/</span><span class="n">outlier_score</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># to normalize the histogram to probability plot</span>
<span class="n">hist</span><span class="p">(</span><span class="n">outlier_score</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">,</span> <span class="n">histtype</span> <span class="o">=</span> <span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;cyan&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">&#39;Distribution of outlier score&#39;</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span> <span class="n">at</span> <span class="mh">0x36030588</span><span class="o">&gt;</span></code></pre></div>

<p><img src="/images/lof_files/lof_16_1.png" alt="center" /></p>

<p>It can be observd that, the optimal outlier score threshold to decide weather a
data-point is outlier is outlier or not is around 2 for most of the cases, so
lets use it to see our sesults.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">threshold</span> <span class="o">=</span> <span class="mf">2.</span>
<span class="c"># plot non outliers as green</span>
<span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c"># find the outliers and plot te outliers</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outlier_score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span> <span class="n">at</span> <span class="mh">0x3640e6a0</span><span class="o">&gt;</span></code></pre></div>

<p><img src="/images/lof_files/lof_18_1.png" alt="center" /></p>

<p>We have seen the results of LOF with naive approachfor KNN queries. Now lets see
optimisations with KD-Trees.</p>

<h4 id="using-kd-trees">Using KD Trees</h4>

<p>KD-Trees insertion and KNN query.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KDTree</span> <span class="k">as</span> <span class="n">Tree</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">BT</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">leaf_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c"># Query for k nearest, k + 1 because one of the returnee is self</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">idx_knn</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;++ took </span><span class="si">%g</span><span class="s"> msecs for Tree KNN Querying&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">++</span> <span class="n">took</span> <span class="mi">122</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">Tree</span> <span class="n">KNN</span> <span class="n">Querying</span></code></pre></div>

<p>LRD computation.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">idx_knn</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">idx_knn</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
<span class="c"># get the radius for each point in dataset</span>
<span class="c"># radius is the distance of kth nearest point for each point in dataset        </span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c"># calculate the local reachability density</span>
<span class="n">LRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">radius</span><span class="p">[</span><span class="n">idx_knn</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&#39;++ took </span><span class="si">%g</span><span class="s"> msecs for LRD computation&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">++</span> <span class="n">took</span> <span class="mf">8.99982</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">LRD</span> <span class="n">computation</span></code></pre></div>

<p>Now, rest is same, so, i'm just replicating the rsult for completion.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># calculating the outlier score</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LRD</span><span class="p">)</span> <span class="c"># inverse of density</span>
<span class="n">outlier_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="n">idx_knn</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<span class="n">outlier_score</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">k</span>
<span class="k">print</span> <span class="s">&#39;+++++ took </span><span class="si">%g</span><span class="s"> msecs for Outlier scoring&#39;</span> <span class="o">%</span>  <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span><span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c"># plotiing the histogram of outlier score</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">outlier_score</span><span class="p">)</span><span class="o">/</span><span class="n">outlier_score</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># to normalize the histogram to probability plot</span>
<span class="n">hist</span><span class="p">(</span><span class="n">outlier_score</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">,</span> <span class="n">histtype</span> <span class="o">=</span> <span class="s">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;cyan&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s">&#39;Distribution of outlier score&#39;</span><span class="p">)</span>

<span class="c">#plotting the result</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">2.</span>
<span class="c"># plot non outliers as green</span>
<span class="n">figure</span><span class="p">()</span>
<span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s">&#39;green&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c"># find the outliers and plot te outliers</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outlier_score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
<span class="n">scatter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s">&#39;None&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></code></pre></div>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">+++++</span> <span class="n">took</span> <span class="mf">4.00019</span> <span class="n">msecs</span> <span class="k">for</span> <span class="n">Outlier</span> <span class="n">scoring</span>

<span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span> <span class="n">at</span> <span class="mh">0x36ad0b38</span><span class="o">&gt;</span></code></pre></div>

<p><img src="/images/lof_files/lof_26_2.png" alt="center" /></p>

<p><img src="/images/lof_files/lof_26_3.png" alt="center" /></p>

<p>The results are same, and should be.</p>

<h4 id="putting-everything-together">Putting everything together</h4>

<p>Lets create a class, to combine evrything together. It will be important in
evaluating performance. From above results, we note that the most time is spent
for KNN querying. Also, i will create a method to compare the performances and see the results.</p>

<script src="https://gist.github.com/bistaumanga/9207578.js" height="50"></script>

<p>Now, lets compare the performace of 2 methods- Naive and KDTree implementations.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">perf_test</span><span class="p">(</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Tree&#39;</span><span class="p">,</span> <span class="s">&#39;Naive&#39;</span><span class="p">],</span> <span class="n">n_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">)],</span> <span class="n">plot</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span></code></pre></div>

<p><img src="/images/lof_files/lof_35_1.png" alt="center" /></p>

<p>We see that KDTree outperforms Naive method for narge $n$, but it may not do
well for small number of datasets. In my PC, i cannot run Naive method beyond
$2^{13}$ datapoints, or else i receie MemoryError. So, lets evauate te
performance of KDTrees upto 1Million datapoints.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">perf_test</span><span class="p">(</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Tree&#39;</span><span class="p">],</span> <span class="n">n_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">)],</span> <span class="n">plot</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span></code></pre></div>

<p><img src="/images/lof_files/lof_37_1.png" alt="center" /></p>

<p>We can see, algorithm is scaling well with data-set size $n$. If we analyse the
complexity of algorithm, its linearithmic , i.e. $\Theta (n\log{n})$.</p>

<h4 id="download-this-post-as">Download this post as:</h4>
<p><a href="/files/lof/lof.ipynb"><i class="fa fa-file-code-o fa-lg fa-fw" style="color:#007bb6"></i> Ipython Notebook</a> | <a href="/files/lof/lof.pdf"><i class="fa fa-file-pdf-o fa-lg fa-fw" style="color:#007bb6"></i> PDF</a></p>


    <p class=discuss>
        Discuss this post via <a href="mailto:mail@bistaumanga.com.np">e-mail</a>
    </p>


</div>


<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'bistaumanga'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        

    </div>

      <br><br>
    </div>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'bistaumanga'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>



    <script type="text/javascript">
    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/platform.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    </script>

 <div id="footer">
  <div class="row">
    <div class="col-sm-offset-4 col-sm-8" align="center">
        <i class="fa fa-copyright fa-fw"></i>
        <a href = "/">umb</a> 
        <i class="fa fa-code fa-lg fa-fw" style="color:#000;"></i>
        with <a href = "http://jekyllrb.com/" target="_blank">Jekyll</a>, 
        <a href = "http://getbootstrap.com/" target="_blank">Bootstrap</a>
        <i class="fa fa-database fa-fw" style="color:#000;"></i>
        @<a href = "https://pages.github.com/" target="_blank">
        <i class="fa fa-github fa-lg"></i> </a>
    </div>
  </div>
</div>
 
</body>
</html>
